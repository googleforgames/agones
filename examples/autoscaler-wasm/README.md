# Autoscaler WASM Example

This example demonstrates how to build and use a WebAssembly (WASM) plugin that implements a custom Agones FleetAutoscaler policy using the [Extism PDK for Go](https://github.com/extism/go-pdk).

The WASM plugin provides a flexible way to implement custom autoscaling logic that runs directly within the Agones controller, without requiring a separate webhook service.

## Overview

The plugin exports two WASM functions:

- **scale**: Implements a buffer-based autoscaling policy that ensures there is always a configurable number of ready replicas available for allocation. The buffer size is configurable via the `buffer_size` config entry and defaults to 5.
- **scaleNone**: A no-op example function that always returns the current replica count without scaling. This demonstrates how to export multiple functions from a single WASM module.

### How it works

The `scale` function calculates the desired replica count using the formula:
```
desired_replicas = allocated_replicas + buffer_size
```

If the current replica count differs from the desired count, the plugin signals that scaling is needed and returns the new target replica count.

### Installing extism CLI

If you don't have the extism CLI installed, you can use the Agones build environment which includes it:

```bash
cd ../../build
make shell
```

This will drop you into a shell with the required extism CLI and Go version available in the PATH.

## Files

- **main.go**: The WASM plugin implementation using github.com/extism/go-pdk
- **model.go**: Minimal request/response models mirroring the FleetAutoscaler webhook types used by Agones
- **Makefile**: Convenience targets to build and locally test the WASM module
- **autoscaler.yaml**: Example FleetAutoscaler configuration that uses the WASM plugin
- **plugin.wasm**: Pre-built WASM binary (generated by `make build`)

## Building the WASM Plugin

To compile the WASM plugin:

```bash
make build
```

This produces `plugin.wasm` in the current directory using the WASI target:
```bash
GOOS=wasip1 GOARCH=wasm go build -buildvcs=false -buildmode=c-shared -o plugin.wasm
```

## Testing Locally

To test the plugin locally with a sample request:

```bash
make test
```

This runs the `scale` function with a minimal FleetAutoscaleReview JSON input using the extism CLI. The test demonstrates how the plugin processes a fleet with:
- 5 total replicas
- 2 allocated replicas
- Default buffer size of 5

Expected output should show the plugin calculating that 7 replicas are needed (2 allocated + 5 buffer).

### Testing with custom arguments

You can override the test arguments by supplying `ARGS`. For example, to test with a custom buffer size:

```bash
make test ARGS='--config buffer_size=10'
```

To call the alternate `scaleNone` export:

```bash
extism call plugin.wasm scaleNone --input '{"request":{"uid":"sample-uid","name":"sample-fleet","namespace":"default","status":{"replicas":5,"readyReplicas":3,"reservedReplicas":1,"allocatedReplicas":2}}}' --wasi
```

## Deploying to Kubernetes

### Step 1: Create a Fleet

First, create a Fleet of game servers. You can use the simple-game-server example:

```bash
kubectl apply -f ../simple-game-server/fleet.yaml
```

### Step 2: Deploy the FleetAutoscaler

The `autoscaler.yaml` file contains an example FleetAutoscaler configuration that uses the WASM plugin:

```bash
kubectl apply -f autoscaler.yaml
```
